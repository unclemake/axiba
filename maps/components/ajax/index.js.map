{"version":3,"sources":["components/ajax/index.ts"],"names":[],"mappings":"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","file":"../../../assets/components/ajax/index.js","sourcesContent":["import * as superagent from 'superagent';\r\nimport { error as errorMsg } from '../Notification/index';\r\n\r\n// 添加后端访问路径等处理\r\nexport function get(url: string, data?: { [key: string]: any }, type?: number) {\r\n    return ajax(url, data, type, 'get');\r\n}\r\n\r\nexport function post(url: string, data?: { [key: string]: any }, type?: number) {\r\n    return ajax(url, data, type, 'post');\r\n}\r\n\r\nexport function put(url: string, data?: { [key: string]: any }, type?: number) {\r\n    return ajax(url, data, type, 'put');\r\n}\r\n\r\nexport function del(url: string, data?: { [key: string]: any }, type?: number) {\r\n    return ajax(url, data, type, 'delete');\r\n}\r\n\r\nlet ajaxRecordArray: Array<AjaxRecord> = []\r\n\r\ninterface AjaxRecord {\r\n    url: string,\r\n    time: Date,\r\n    type: number,\r\n    data: { [key: string]: any },\r\n    ajaxType: string,\r\n    setTimeout?: any,\r\n    responseDate?: AjaxData,\r\n    response?: superagent.Response\r\n}\r\n\r\ninterface AjaxData {\r\n    status: number,\r\n    data: string | { [key: string]: string },\r\n    message: string\r\n}\r\n\r\n\r\ninterface AjaxFunction {\r\n    (url: string, data?: { [key: string]: any }, type?: number, ajaxType?: string): Promise<AjaxData | never>\r\n}\r\n\r\n\r\ninterface TypeFunction {\r\n    (url: string, data?: { [key: string]: any }, type?: number, ajaxType?: string, ajaxRecord?: AjaxRecord): Promise<AjaxData | never>\r\n}\r\n\r\nlet typeFunctionArray: Array<TypeFunction> = [\r\n    //同url同参数同类型 上一个完成时过 400ms 才能请求下一个\r\n    (url, data, type, ajaxType, ajaxRecord) => {\r\n        let ajaxRecordGet = ajaxRecordArray.find(value => {\r\n            return value != ajaxRecord &&\r\n                value.url === url &&\r\n                value.data === data &&\r\n                value.ajaxType === ajaxType &&\r\n                 ajaxRecord.time.getTime() - value.time.getTime() < 400\r\n        });\r\n\r\n        if (ajaxRecordGet) {\r\n            ajaxRecordArray = ajaxRecordArray.filter(value => value != ajaxRecord);\r\n            //不返回\r\n            return new Promise<AjaxData>(() => { });\r\n        }\r\n    },\r\n    //缓存\r\n    (url, data, type, ajaxType, ajaxRecord) => {\r\n        return new Promise<AjaxData>((reslove, reject) => {\r\n            var ajaxRecordGet = ajaxRecordArray.find(value => {\r\n                return value != ajaxRecord &&\r\n                    value.url === url &&\r\n                    value.data === data &&\r\n                    value.ajaxType === ajaxType\r\n            });\r\n            if (ajaxRecordGet) {\r\n                ajaxRecordArray = ajaxRecordArray.filter(value => value != ajaxRecord);\r\n                if (ajaxRecordGet.responseDate) {\r\n                    return reslove(ajaxRecordGet.responseDate);\r\n                } else {\r\n                    ajaxRecordGet.response.on('end', () => {\r\n                        reslove(ajaxRecordGet.responseDate);\r\n                    });\r\n                }\r\n            }\r\n            reslove();\r\n        });\r\n    },\r\n    //延迟提交 400ms\r\n    (url, data, type, ajaxType, ajaxRecord) => {\r\n        return new Promise<AjaxData>((reslove, reject) => {\r\n            let ajaxRecordGet = ajaxRecordArray.find(value => {\r\n                return value != ajaxRecord &&\r\n                    value.url === url &&\r\n                    value.data === data &&\r\n                    value.ajaxType === ajaxType &&\r\n                    ajaxRecord.time.getTime() - value.time.getTime() < 400\r\n            });\r\n            if (ajaxRecordGet) {\r\n                clearTimeout(ajaxRecordGet.setTimeout);\r\n            }\r\n            ajaxRecord.setTimeout = setTimeout(function () {\r\n                reslove();\r\n            }, 400);\r\n\r\n        });\r\n    }\r\n]\r\n\r\n\r\nexport let ajax: AjaxFunction = async (url, data, type = 0, ajaxType = 'get') => {\r\n    let ajaxRequest: superagent.SuperAgentRequest;\r\n    let ajaxRecord: AjaxRecord = {\r\n        url,\r\n        time: new Date(),\r\n        data,\r\n        type,\r\n        ajaxType\r\n    };\r\n\r\n    //创建请求\r\n    switch (ajaxType) {\r\n        case 'delete':\r\n            ajaxRequest = superagent.delete(url);\r\n            break;\r\n        case 'put':\r\n            ajaxRequest = superagent.put(url);\r\n            break;\r\n        case 'get':\r\n            ajaxRequest = superagent.get(url);\r\n            break;\r\n        case 'post':\r\n            ajaxRequest = superagent.post(url);\r\n            break;\r\n    }\r\n\r\n    //创建请求数据\r\n    if (data) {\r\n        ajaxRequest = ajaxRequest.send(data);\r\n    }\r\n\r\n    ajaxRecordArray.unshift(ajaxRecord);\r\n    let typeFunctionValue = await typeFunctionArray[type](url, data, type, ajaxType, ajaxRecord);\r\n    if (typeFunctionValue) {\r\n        return typeFunctionValue;\r\n    }\r\n    //添加请求记录\r\n\r\n    let promiseFunction = (reslove, reject) => {\r\n        //发送请求\r\n        ajaxRequest.end((error, res) => {\r\n            ajaxRecord.response = res;\r\n            if (error) {\r\n                errorMsg({\r\n                    message: `请求错误!`,\r\n                    description: 'status:${res.status}'\r\n                });\r\n                reject(ajaxRecord.responseDate);\r\n            } else {\r\n                try {\r\n                    ajaxRecord.responseDate = JSON.parse(res.text);\r\n                } catch (error) {\r\n                    ajaxRecord.responseDate = {\r\n                        status: 0,\r\n                        data: res.text,\r\n                        message: ''\r\n                    };\r\n                }\r\n                reslove(ajaxRecord.responseDate);\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n    return new Promise<AjaxData>(promiseFunction);\r\n}\r\n\r\n"]}